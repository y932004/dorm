<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æƒ…ç·’æ°´å½©å®¤ï½œEmotion Watercolor</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f4f7fb;
      color: #333;
      min-height: 100vh;
    }

    /* Login */
    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .login-card {
      background: #ffffff;
      border-radius: 14px;
      padding: 20px 22px;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    .login-card h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }
    .login-card p {
      margin: 0 0 14px;
      font-size: 13px;
      color: #666;
    }
    .login-card input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #cfd8dc;
      padding: 8px 10px;
      font-size: 13px;
      outline: none;
      margin-bottom: 12px;
    }
    .login-card input:focus {
      border-color: #64b5f6;
      box-shadow: 0 0 0 2px rgba(100,181,246,0.3);
    }
    .login-card button {
      width: 100%;
      border-radius: 999px;
      border: none;
      background: #1e88e5;
      color: #fff;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .login-card button:hover {
      background: #1976d2;
    }
    .login-note {
      margin-top: 10px;
      font-size: 12px;
      color: #78909c;
      line-height: 1.5;
    }

    /* App layout */
    #appView {
      display: none;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 12px 24px;
      background: #e3f2fd;
      border-bottom: 1px solid #cfd8dc;
    }
    .header-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: #555;
    }
    .header-left {
      min-width: 0;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .nav-tabs {
      display: inline-flex;
      background: #bbdefb;
      border-radius: 999px;
      padding: 2px;
    }
    .tab {
      border: none;
      background: transparent;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      color: #1e3a5f;
    }
    .tab.active {
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #455a64;
    }
    .user-info strong {
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .link-btn {
      border: none;
      background: transparent;
      font-size: 12px;
      color: #1565c0;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(320px, 450px) minmax(360px, 1fr);
      gap: 16px;
      padding: 16px 24px 24px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .panel p.hint {
      margin: 0 0 12px;
      font-size: 12px;
      color: #777;
      line-height: 1.4;
    }

    textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #cfd8dc;
      font-size: 13px;
      outline: none;
    }
    textarea:focus,
    input[type="text"]:focus {
      border-color: #64b5f6;
      box-shadow: 0 0 0 2px rgba(100,181,246,0.25);
    }
    input[type="text"] {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #cfd8dc;
      padding: 6px 8px;
      font-size: 12px;
      margin-top: 4px;
      outline: none;
    }

    .field {
      margin-top: 12px;
      font-size: 13px;
    }
    .field label.title {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .emotion-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .emotion-btn {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      flex-direction: row;
      align-items: center;
      gap: 4px;
      transition: all 0.15s ease;
      max-width: 48%;
      white-space: nowrap;
      border: 1px solid transparent;
      color: #263238;
    }
    .emotion-btn span.emoji {
      font-size: 14px;
    }
    .emotion-btn span.label-text {
      font-size: 11px;
    }
    .emotion-btn.active {
      box-shadow: 0 0 0 2px #1976d2;
      border-color: #1976d2;
      transform: translateY(-1px);
    }

    .chips, .radios {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip, .radio-pill {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #cfd8dc;
      background: #fafafa;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }
    .chip input,
    .radio-pill input {
      pointer-events: none;
    }
    .chip.active,
    .radio-pill.active {
      background: #bbdefb;
      border-color: #64b5f6;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .slider-row input[type="range"] {
      flex: 1;
    }
    .slider-value {
      width: 28px;
      text-align: center;
      font-size: 12px;
      color: #555;
    }

    .btn-row {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    button.ghost {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #b0bec5;
      background: #ffffff;
      cursor: pointer;
      font-size: 13px;
      color: #546e7a;
    }

    .canvas-wrapper {
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%;
    }
    .canvas-stack {
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 320px;
      border-radius: 16px;
      box-shadow: inset 0 0 0 1px #e0e0e0;
      overflow: hidden;
      background: #ffffff;
    }
    #watercolorCanvas,
    #crayonCanvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border-radius: 16px;
      background: transparent;
    }

    .note {
      font-size: 11px;
      color: #777;
      line-height: 1.5;
    }
    .summary {
      font-size: 12px;
      color: #455a64;
      background: #e3f2fd;
      border-radius: 8px;
      padding: 6px 8px;
      margin-top: 4px;
    }

    .crayon-tools {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .crayon-colors {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .crayon-color-btn {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
    }
    .crayon-color-btn.active {
      border-color: #263238;
      box-shadow: 0 0 0 2px rgba(38,50,56,0.6);
    }
    .crayon-label {
      font-size: 11px;
      color: #607d8b;
    }

    /* History view */
    #historyView {
      display: none;
      grid-template-columns: minmax(260px, 380px) minmax(360px, 1fr);
    }
    .stats-chart {
      margin-top: 10px;
      border-radius: 10px;
      background: #f5f9ff;
      padding: 10px 10px 6px;
      max-height: 380px;
      overflow: auto;
    }
    .bar-row {
      display: grid;
      grid-template-columns: 70px 1fr 30px;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 11px;
    }
    .bar-label {
      color: #455a64;
    }
    .bar-track {
      height: 8px;
      border-radius: 999px;
      background: #e3f2fd;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      border-radius: 999px;
    }
    .bar-value {
      text-align: right;
      color: #607d8b;
    }

    .records-list {
      max-height: 480px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-right: 4px;
    }
    .record-card {
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      background: #fafafa;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 8px;
      align-items: flex-start;
      font-size: 12px;
    }
    @media (max-width: 900px) {
      .record-card {
        grid-template-columns: 1fr;
      }
    }
    .record-meta {
      color: #607d8b;
      margin-bottom: 4px;
    }
    .record-text {
      color: #37474f;
      margin-bottom: 4px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .record-img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .record-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #1e3a5f;
    }
    .badge.main {
      background: #ffebee;
      color: #c62828;
    }
    .record-empty {
      font-size: 12px;
      color: #78909c;
      margin-top: 8px;
    }

    .range-pills {
      margin-top: 4px;
    }
  </style>
</head>
<body>

<!-- Login View -->
<div id="loginView" class="login-wrapper">
  <div class="login-card">
    <h1>æƒ…ç·’æ°´å½©å®¤</h1>
    <p>è¼¸å…¥æƒ³åœ¨é€™è£¡ä½¿ç”¨çš„æš±ç¨±ï¼Œå°±å¯ä»¥é–‹å§‹å‰µä½œèˆ‡ç´€éŒ„ã€‚<br>ç›®å‰åªè¨­è¨ˆå–®ä¸€å¸³è™Ÿï¼Œåœ¨é€™å°è£ç½®ä¸Šæœƒè¨˜ä½ä½ çš„ç´€éŒ„ã€‚</p>
    <input id="loginName" type="text" placeholder="è¼¸å…¥æš±ç¨±ï¼Œä¾‹å¦‚ï¼šFreda" />
    <button id="loginBtn">ç™»å…¥</button>
    <div class="login-note">
      è³‡æ–™åƒ…å„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ä¸­ï¼ˆlocalStorageï¼‰ï¼Œä¸æœƒä¸Šå‚³ä¼ºæœå™¨ã€‚<br>
      è‹¥æ¸…é™¤ç€è¦½å™¨è³‡æ–™ï¼Œç´€éŒ„ä¹Ÿæœƒä¸€ä½µæ¶ˆå¤±ã€‚
    </div>
  </div>
</div>

<!-- App View -->
<div id="appView">
  <header>
    <div class="header-main">
      <div class="header-left">
        <h1>æƒ…ç·’æ°´å½©å®¤ Emotion Watercolor</h1>
        <p>è¼¸å…¥ç•¶ä¸‹çš„å¿ƒæƒ…èˆ‡è„ˆçµ¡ï¼Œç•«å¸ƒæœƒè‡ªå‹•å›æ‡‰ï¼Œè®Šæˆä¸€å¹…å±¬æ–¼ä½ çš„æ°´å½©ï¼‹è Ÿç­†ä½œå“ã€‚</p>
      </div>
      <div class="header-right">
        <div class="nav-tabs">
          <button id="tabCreate" class="tab active">å‰µä½œç•«å¸ƒ</button>
          <button id="tabHistory" class="tab">æƒ…ç·’ç´€éŒ„</button>
        </div>
        <div class="user-info">
          <span>ç™»å…¥èº«åˆ†ï¼š</span>
          <strong id="userNameLabel"></strong>
          <button id="logoutBtn" class="link-btn">ç™»å‡º</button>
        </div>
      </div>
    </div>
  </header>

  <!-- å‰µä½œç•«å¸ƒ view -->
  <main id="createView">
    <!-- å·¦å´ï¼šè¼¸å…¥èˆ‡å¿ƒç†æŒ‡æ¨™ -->
    <section class="panel">
      <h2>1. è·Ÿç•«å¸ƒèªªèªªä»Šå¤©çš„ä½ </h2>
      <p class="hint">é€™ä¸æ˜¯æ¸¬é©—ï¼Œä½ å¯ä»¥åªå¯«ä¸€å…©å¥ï¼Œä¹Ÿå¯ä»¥å¤šå¯«ä¸€é»ã€‚é€™å¹…ç•«åªå±¬æ–¼ç¾åœ¨çš„ä½ ã€‚</p>

      <textarea id="moodText" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿæˆ–æ­¤åˆ»ä½ åœ¨æƒ³ä»€éº¼å‘¢ï¼Ÿ"></textarea>

      <!-- è§¸ç™¼ä¾†æºï¼šäº‹æƒ…ï¼äººï¼è‡ªå·± -->
      <div class="field">
        <label class="title">é€™ä»½æƒ…ç·’æ¯”è¼ƒæ˜¯å› ç‚ºâ‹¯</label>
        <div class="radios" id="sourceGroup">
          <label class="radio-pill active">
            <input type="radio" name="source" value="thing" checked />
            ä¸€ä»¶äº‹æƒ…ï¼æƒ…å¢ƒ
          </label>
          <label class="radio-pill">
            <input type="radio" name="source" value="person" />
            æŸå€‹äººæˆ–é—œä¿‚
          </label>
          <label class="radio-pill">
            <input type="radio" name="source" value="self" />
            è‡ªå·±çš„ç‹€æ…‹ï¼ˆä¾‹å¦‚èº«é«”ã€å€‹æ€§ï¼‰
          </label>
          <label class="radio-pill">
            <input type="radio" name="source" value="unknown" />
            èªªä¸å¤ªä¸Šä¾†
          </label>
        </div>
        <input type="text" id="triggerEvent" placeholder="è‹¥æ˜¯äº‹æƒ…ï¼šç°¡å–®å¯«ä¸€ä¸‹ï¼Œä¾‹å¦‚ã€Œå ±å‘Šè¢«é€€ä»¶ã€ã€Œè·Ÿå®¶äººåµæ¶ã€â‹¯" />
        <input type="text" id="triggerPerson" placeholder="è‹¥æ˜¯äººï¼šå’Œèª°æœ‰é—œï¼Ÿå¯ä»¥å¯«ã€Œå®¤å‹ã€ã€Œå®¶äººã€ã€Œè€å¸«ã€æˆ–æš±ç¨±å³å¯ã€‚" />
      </div>

      <!-- æƒ…ç·’åäºŒè‰²ç›¸ï¼ˆä¼Šç™»ï¼‰ -->
      <div class="field">
        <label class="title">é€™æ¯”è¼ƒåƒå“ªä¸€ç¨®æ„Ÿè¦ºï¼Ÿï¼ˆå°æ‡‰ä¼Šç™»åäºŒè‰²ç›¸ç’°ï¼‰</label>
        <div class="emotion-buttons" id="emotionButtons">
          <!-- æ†¤æ€’ï¼šç´… -->
          <button class="emotion-btn" data-valence="-1.5" data-hue="0" data-key="anger" style="background:#e53935;">
            <span class="emoji">ğŸ”¥</span><span class="label-text">æ†¤æ€’ï¼è¢«è¸©åˆ°åº•ç·š</span>
          </button>
          <button class="emotion-btn" data-valence="-1.2" data-hue="20" data-key="fight" style="background:#ff7043;">
            <span class="emoji">âš¡</span><span class="label-text">è¢«é»ç‡ƒï¼æƒ³åæ“Š</span>
          </button>
          <button class="emotion-btn" data-valence="0.5" data-hue="35" data-key="playful" style="background:#fb8c00;">
            <span class="emoji">ğŸ­</span><span class="label-text">å¥½ç©ï¼æœ‰é»èª¿çš®</span>
          </button>
          <button class="emotion-btn" data-valence="1.0" data-hue="45" data-key="smallJoy" style="background:#ffb300;">
            <span class="emoji">ğŸŒ¤ï¸</span><span class="label-text">å°ç¢ºå¹¸ï¼å¾®å¾®é–‹å¿ƒ</span>
          </button>
          <button class="emotion-btn" data-valence="1.5" data-hue="60" data-key="joy" style="background:#fdd835;">
            <span class="emoji">ğŸ˜Š</span><span class="label-text">é–‹å¿ƒï¼æœ‰å¸Œæœ›</span>
          </button>
          <button class="emotion-btn" data-valence="-0.5" data-hue="90" data-key="anxious" style="background:#9ccc65;">
            <span class="emoji">ğŸ˜°</span><span class="label-text">ç„¦èºï¼æ“”å¿ƒ</span>
          </button>
          <button class="emotion-btn" data-valence="0.2" data-hue="130" data-key="calm" style="background:#43a047;">
            <span class="emoji">ğŸŒ¿</span><span class="label-text">å®‰ç©©ï¼å¹³éœ</span>
          </button>
          <button class="emotion-btn" data-valence="-0.8" data-hue="170" data-key="lonely" style="background:#26a69a;">
            <span class="emoji">ğŸš¶</span><span class="label-text">å­¤å–®ï¼è¢«è½ä¸‹</span>
          </button>
          <button class="emotion-btn" data-valence="-1.2" data-hue="210" data-key="sad" style="background:#1e88e5;">
            <span class="emoji">ğŸ˜¢</span><span class="label-text">æ‚²å‚·ï¼æƒ³å“­</span>
          </button>
          <button class="emotion-btn" data-valence="-1.8" data-hue="250" data-key="despair" style="background:#5e35b1;">
            <span class="emoji">ğŸ’§</span><span class="label-text">çµ•æœ›ï¼éå¸¸ç„¡åŠ›</span>
          </button>
          <button class="emotion-btn" data-valence="-1.0" data-hue="280" data-key="numb" style="background:#8e24aa;">
            <span class="emoji">ğŸªµ</span><span class="label-text">éº»æœ¨ï¼ç©ºæ‰</span>
          </button>
          <button class="emotion-btn" data-valence="-0.8" data-hue="320" data-key="hurt" style="background:#d81b60;">
            <span class="emoji">ğŸ’”</span><span class="label-text">å—å‚·ï¼å§”å±ˆ</span>
          </button>
        </div>
        <p id="emotionDesc" class="hint" style="margin-top:4px;">
          é¸ä¸€å€‹æœ€æ¥è¿‘çš„å°±å¥½ï¼Œä¸éœ€è¦ã€Œé¸å°ã€ã€‚é¡è‰²æœƒä¸€èµ·å¸¶é€²ç•«é¢è£¡ã€‚
        </p>
      </div>

      <!-- å››æ§‹é¢ -->
      <div class="field">
        <label class="title">æ­¤åˆ»æƒ…ç·’å¼·åº¦ï¼ˆArousalï¼‰</label>
        <div class="slider-row">
          <input type="range" id="arousal" min="1" max="5" value="3" />
          <span class="slider-value" id="arousalValue">3</span>
        </div>
        <p class="hint" style="margin-top:4px;">
          1 åƒæ˜¯é é çš„å½±å­ï¼Œ5 å‰‡æ˜¯æ•´å€‹äººéƒ½è¢«æ²é€²å»ã€‚
        </p>
      </div>

      <div class="field">
        <label class="title">æŒæ§æ„Ÿï¼ˆControlï¼‰</label>
        <div class="slider-row">
          <input type="range" id="control" min="1" max="5" value="3" />
          <span class="slider-value" id="controlValue">3</span>
        </div>
        <p class="hint" style="margin-top:4px;">
          1ï¼å®Œå…¨è¢«æƒ…ç·’æ‹‰è‘—èµ°ï¼Œ5ï¼æˆ‘é‚„æŒæ¡æŸäº›é¸æ“‡ã€‚
        </p>
      </div>

      <div class="field">
        <label class="title">èˆ‡ä»–äººçš„é€£çµæ„Ÿï¼ˆSocial connectionï¼‰</label>
        <div class="slider-row">
          <input type="range" id="social" min="1" max="5" value="3" />
          <span class="slider-value" id="socialValue">3</span>
        </div>
        <p class="hint" style="margin-top:4px;">
          1ï¼å¾ˆå­¤å–®ï¼è¢«éš”é–‹ï¼Œ5ï¼æœ‰è¢«çœ‹è¦‹ã€æœ‰äººåœ¨æ—é‚Šã€‚
        </p>
      </div>

      <!-- æ”¯æŒæ„Ÿ -->
      <div class="field">
        <label class="title">ä½ è¦ºå¾—ç¾åœ¨æœ‰äººåœ¨èº«é‚Šæ”¯æŒå—ï¼Ÿ</label>
        <div class="radios" id="supportGroup">
          <label class="radio-pill active">
            <input type="radio" name="support" value="2" checked />
            æœ‰ï¼Œé‚„æ»¿æ˜é¡¯çš„
          </label>
          <label class="radio-pill">
            <input type="radio" name="support" value="1" />
            æœ‰ä¸€é»ï¼Œä½†ä¸å¤š
          </label>
          <label class="radio-pill">
            <input type="radio" name="support" value="0" />
            å¹¾ä¹æ˜¯è‡ªå·±æ’è‘—
          </label>
        </div>
      </div>

      <!-- èº«é«”æ„Ÿå— -->
      <div class="field">
        <label class="title">èº«é«”æœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿï¼ˆå¯è¤‡é¸ï¼Œå¤šé¸æœƒç–Šæ›´å¤šæ°´å½©å±¤ï¼‰</label>
        <div class="chips" id="bodyGroup">
          <label class="chip">
            <input type="checkbox" value="head_pressure" />
            é ­å¾ˆè„¹ï¼æšˆ
          </label>
          <label class="chip">
            <input type="checkbox" value="eye_strain" />
            çœ¼ç›å¾ˆç´¯
          </label>
          <label class="chip">
            <input type="checkbox" value="shoulder_tense" />
            è‚©é ¸ç·Šç¹ƒ
          </label>
          <label class="chip">
            <input type="checkbox" value="chest_heavy" />
            èƒ¸å£æ‚¶æ‚¶çš„
          </label>
          <label class="chip">
            <input type="checkbox" value="heart_fast" />
            å¿ƒè·³å¾ˆå¿«
          </label>
          <label class="chip">
            <input type="checkbox" value="stomach_unwell" />
            èƒƒä¸å¤ªèˆ’æœ
          </label>
          <label class="chip">
            <input type="checkbox" value="cold_limbs" />
            æ‰‹è…³å†°å†·
          </label>
          <label class="chip">
            <input type="checkbox" value="body_tired" />
            å…¨èº«å¾ˆç–²æ†Š
          </label>
          <label class="chip">
            <input type="checkbox" value="belly_warm" />
            è‚šå­æš–æš–çš„
          </label>
          <label class="chip">
            <input type="checkbox" value="body_relaxed" />
            èº«é«”æ•´é«”æ»¿æ”¾é¬†
          </label>
        </div>
      </div>

      <!-- è‡ªæˆ‘æ¥ç´ -->
      <div class="field">
        <label class="title">ä½ å°ç¾åœ¨é€™æ¨£çš„è‡ªå·±ï¼Ÿï¼ˆSelf-compassionï¼‰</label>
        <div class="radios" id="selfGroup">
          <label class="radio-pill">
            <input type="radio" name="selfAccept" value="0" />
            æœ‰é»è‹›è²¬
          </label>
          <label class="radio-pill active">
            <input type="radio" name="selfAccept" value="1" checked />
            é‚„å¥½ï¼Œèƒ½ç†è§£
          </label>
          <label class="radio-pill">
            <input type="radio" name="selfAccept" value="2" />
            å¯ä»¥æº«æŸ”çœ‹å¾…
          </label>
        </div>
      </div>

      <div class="btn-row">
        <button id="downloadBtn" class="ghost">
          å­˜æª” & ä¸‹è¼‰åœ–ç‰‡
        </button>
      </div>

      <div class="summary" id="summaryText" style="display:none;"></div>
    </section>

    <!-- å³å´ï¼šç•«å¸ƒ -->
    <section class="panel">
      <div class="canvas-wrapper">
        <h2>2. ä½ çš„æƒ…ç·’æ°´å½©ï¼‹è Ÿç­†ç•«å¸ƒ</h2>
        <p class="hint">
          ä½œå“æ²’æœ‰å¥½å£ï¼Œåªæ˜¯åœ¨è¨˜éŒ„ã€Œæ­¤åˆ»çš„ä½ ã€ã€‚<br>
          ä½ å¯ä»¥ç”¨è Ÿç­†åœ¨ä¸Šå±¤ç•«ç·šæˆ–ç•«æ»¿ä¸€å¡Šå€åŸŸï¼ˆå·¦å³å‚ç›´å°ç¨±ï¼‰ï¼Œç•¶æˆã€Œæˆ‘å°é€™å€‹æƒ…ç·’çš„å›æ‡‰ã€ã€‚
        </p>
        <div class="canvas-stack">
          <canvas id="watercolorCanvas"></canvas>
          <canvas id="crayonCanvas"></canvas>
        </div>

        <div class="crayon-tools">
          <div class="crayon-colors" id="crayonColors">
            <span class="crayon-label">è Ÿç­†é¡è‰²ï¼š</span>
            <button class="crayon-color-btn active" data-color="#263238" style="background:#263238;"></button>
            <button class="crayon-color-btn" data-color="#ef5350" style="background:#ef5350;"></button>
            <button class="crayon-color-btn" data-color="#ffb300" style="background:#ffb300;"></button>
            <button class="crayon-color-btn" data-color="#66bb6a" style="background:#66bb6a;"></button>
            <button class="crayon-color-btn" data-color="#42a5f5" style="background:#42a5f5;"></button>
            <button class="crayon-color-btn" data-color="#ab47bc" style="background:#ab47bc;"></button>
            <button class="crayon-color-btn" data-color="#f06292" style="background:#f06292;"></button>
            <button class="crayon-color-btn" data-color="#ffffff" style="background:#ffffff;"></button>
          </div>
          <p class="hint">
            æ»‘é¼ æŒ‰ä½æ‹–æ›³å¯ä»¥ç•«å‡ºé€£çºŒã€æŸ”è»Ÿçš„ç·šæ¢èˆ‡é¢ï¼Œå·¦å³æœƒå‚ç›´å°ç¨±ï¼›è Ÿç­†ä¸æœƒè¢«é‡æ–°ç”Ÿæˆçš„æ°´å½©æ´—æ‰ã€‚
          </p>
        </div>

        <p class="note">
          å°æé†’ï¼šé€™å€‹ç¶²ç«™ä¸å–ä»£å°ˆæ¥­è«®å•†ã€‚å¦‚æœä½ æ­£ç¶“æ­·å¾ˆè¾›è‹¦çš„ç‹€æ…‹ï¼Œä»ç„¶é¼“å‹µå°‹æ±‚å°ˆæ¥­æˆ–ä¿¡ä»»çš„äººé™ªä¼´ã€‚<br>
          ï¼ˆæŠ€è¡“èªªæ˜ï¼šç•«é¢ä¾æ“šæƒ…ç·’è‰²ç›¸ï¼ˆä¼Šç™»åäºŒè‰²ç’°ï¼‰ã€å¼·åº¦ã€æŒæ§æ„Ÿã€é€£çµæ„Ÿã€èº«é«”æ„Ÿå—èˆ‡æ–‡å­—å¤šé‡æƒ…ç·’ï¼Œè½‰æˆå¤šå±¤æ°´å½©èˆ‡è Ÿç­†ã€‚ï¼‰ 
        </p>
      </div>
    </section>
  </main>

  <!-- æƒ…ç·’ç´€éŒ„ view -->
  <main id="historyView">
    <section class="panel">
      <h2>æƒ…ç·’çµ±è¨ˆ</h2>
      <div class="field">
        <label class="title">æ™‚é–“ç¯„åœ</label>
        <div class="radios range-pills" id="rangeGroup">
          <label class="radio-pill active">
            <input type="radio" name="range" value="all" checked />
            å…¨éƒ¨
          </label>
          <label class="radio-pill">
            <input type="radio" name="range" value="day" />
            ä»Šå¤©
          </label>
          <label class="radio-pill">
            <input type="radio" name="range" value="week" />
            è¿‘ä¸€é€±
          </label>
          <label class="radio-pill">
            <input type="radio" name="range" value="month" />
            è¿‘ä¸€å€‹æœˆ
          </label>
        </div>
      </div>
      <div id="statsChart" class="stats-chart"></div>
      <p class="hint">
        æŸ±ç‹€åœ–é¡¯ç¤ºåœ¨é¸å®šç¯„åœå…§ï¼Œå„ç¨®æƒ…ç·’è¢«é¸æ“‡ï¼ˆä¸»æƒ…ç·’ï¼‰æˆ–åœ¨æ–‡å­—ä¸­è¢«æåˆ°çš„æ¬¡æ•¸ã€‚<br>
        å®ƒä¸æ˜¯è¨ºæ–·ï¼Œåªæ˜¯å¹«ä½ çœ‹åˆ°ä¸€æ®µæ™‚é–“å…§ï¼Œå“ªäº›æ„Ÿå—æ¯”è¼ƒå¸¸å‡ºç¾ã€‚
      </p>
    </section>

    <section class="panel">
      <h2>æ­·å²ä½œå“</h2>
      <div id="recordsList" class="records-list"></div>
    </section>
  </main>
</div>

<script>
  // ====== Login & basic app state ======
  const loginView = document.getElementById('loginView');
  const appView = document.getElementById('appView');
  const loginNameInput = document.getElementById('loginName');
  const loginBtn = document.getElementById('loginBtn');
  const userNameLabel = document.getElementById('userNameLabel');
  const logoutBtn = document.getElementById('logoutBtn');

  const tabCreate = document.getElementById('tabCreate');
  const tabHistory = document.getElementById('tabHistory');
  const createView = document.getElementById('createView');
  const historyView = document.getElementById('historyView');

  let currentUser = null;
  let records = [];
  let currentRange = 'all';

  function loadRecords() {
    const raw = localStorage.getItem('emotionWatercolorRecords');
    if (raw) {
      try {
        records = JSON.parse(raw);
      } catch {
        records = [];
      }
    } else {
      records = [];
    }
  }

  function persistRecords() {
    localStorage.setItem('emotionWatercolorRecords', JSON.stringify(records));
  }

  function showApp(userName) {
    currentUser = userName;
    userNameLabel.textContent = userName;
    loginView.style.display = 'none';
    appView.style.display = 'flex';
    loadRecords();
    renderHistory(currentRange);
    resizeCanvases();
    regenerateNow();
  }

  loginBtn.addEventListener('click', () => {
    const name = (loginNameInput.value || '').trim();
    if (!name) {
      alert('å¯ä»¥éš¨ä¾¿æ‰“å€‹æš±ç¨±ï¼Œä¾‹å¦‚ï¼šFredaã€æŸæ–‡ã€å¿ƒç¶²æ—…äººâ‹¯');
      return;
    }
    localStorage.setItem('emotionWatercolorUser', name);
    showApp(name);
  });

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('emotionWatercolorUser');
    location.reload();
  });

  const storedUser = localStorage.getItem('emotionWatercolorUser');
  if (storedUser) {
    showApp(storedUser);
  } else {
    loginView.style.display = 'flex';
    appView.style.display = 'none';
  }

  // Tabs
  tabCreate.addEventListener('click', () => {
    tabCreate.classList.add('active');
    tabHistory.classList.remove('active');
    createView.style.display = 'grid';
    historyView.style.display = 'none';
  });
  tabHistory.addEventListener('click', () => {
    tabHistory.classList.add('active');
    tabCreate.classList.remove('active');
    createView.style.display = 'none';
    historyView.style.display = 'grid';
    renderHistory(currentRange);
  });

  // ====== äº’å‹• &ç•«å¸ƒé‚è¼¯ ======
  const moodText = document.getElementById('moodText');
  const sourceGroup = document.getElementById('sourceGroup');
  const triggerEventInput = document.getElementById('triggerEvent');
  const triggerPersonInput = document.getElementById('triggerPerson');

  const emotionButtons = document.getElementById('emotionButtons');
  const emotionDesc = document.getElementById('emotionDesc');

  const arousalSlider = document.getElementById('arousal');
  const arousalValue = document.getElementById('arousalValue');
  const controlSlider = document.getElementById('control');
  const controlValue = document.getElementById('controlValue');
  const socialSlider = document.getElementById('social');
  const socialValue = document.getElementById('socialValue');

  const supportGroup = document.getElementById('supportGroup');
  const bodyGroup = document.getElementById('bodyGroup');
  const selfGroup = document.getElementById('selfGroup');
  const downloadBtn = document.getElementById('downloadBtn');
  const summaryText = document.getElementById('summaryText');

  const watercolorCanvas = document.getElementById('watercolorCanvas');
  const watercolorCtx = watercolorCanvas.getContext('2d');
  const crayonCanvas = document.getElementById('crayonCanvas');
  const crayonCtx = crayonCanvas.getContext('2d');
  const crayonColors = document.getElementById('crayonColors');

  const rangeGroup = document.getElementById('rangeGroup');
  const statsChart = document.getElementById('statsChart');
  const recordsList = document.getElementById('recordsList');

  const actionLog = [];
  function logAction(type, payload) {
    actionLog.push({
      type,
      time: new Date().toISOString(),
      payload
    });
  }

  const emotionDescriptions = {
    anger: 'æ†¤æ€’å¸¸å¸¸è·Ÿã€Œç•Œç·šè¢«è¸©éã€æœ‰é—œï¼Œä¹Ÿå¯èƒ½è—è‘—å¾ˆå¤šå§”å±ˆå’Œæƒ³ä¿è­·çš„æ±è¥¿ã€‚',
    fight: 'è¢«é»ç‡ƒçš„æ„Ÿè¦ºï¼Œæœ‰ä¸€ç¨®ã€Œä¸æƒ³å†å¿äº†ã€çš„èƒ½é‡ï¼Œæ—¢ç´¯åˆå¸¶è‘—å‹•åŠ›ã€‚',
    playful: 'æœ‰é»èª¿çš®ã€æƒ³è©¦è©¦çœ‹çš„ç‹€æ…‹ï¼Œé€šå¸¸ä»£è¡¨æ­¤åˆ»æœ‰ä¸€é»å®‰å…¨æ„Ÿï¼Œå¯ä»¥ç©ä¸€ä¸‹ã€‚',
    smallJoy: 'æ—¥å¸¸çš„å°ç¢ºå¹¸ï¼Œå¯èƒ½åªæ˜¯å¾ˆå°çš„äº‹ï¼Œä½†æœƒè®“å¿ƒè£¡å¾®å¾®äº®èµ·ä¾†ã€‚',
    joy: 'é–‹å¿ƒèˆ‡å¸Œæœ›è®“ä¸–ç•Œè®Šå¾—æ¯”è¼ƒæœ‰é¡è‰²ï¼Œä¹Ÿæé†’ä½ è‡ªå·±é‚„æœ‰åœ¨åœ¨æ„çš„äº‹ç‰©ã€‚',
    anxious: 'ç„¦èºèˆ‡æ“”å¿ƒå¸¸å¸¸è®“è…¦è¢‹åœä¸ä¸‹ä¾†ï¼Œåƒæ˜¯åœ¨ç­‰å¾…ä¸€ä»¶ä¸çŸ¥é“æœƒä¸æœƒç™¼ç”Ÿçš„äº‹ã€‚',
    calm: 'ä¸ç‰¹åˆ¥å¥½ä¹Ÿä¸ç‰¹åˆ¥å£ï¼Œæ˜¯æŸç¨®ã€Œé‚„æ’å¾—ä½ã€çš„å¹³ç©©ã€‚',
    lonely: 'äººå¯èƒ½åœ¨èº«é‚Šï¼Œä½†å¿ƒè£¡å»è¦ºå¾—æœ‰ä¸€æ®µè·é›¢ï¼Œåƒè¢«ç•™åœ¨åŸåœ°ã€‚',
    sad: 'æ‚²å‚·æœ‰æ™‚å€™å¾ˆå®‰éœï¼Œæœ‰æ™‚å€™æœƒæƒ³å“­ï¼ŒèƒŒå¾Œå¤šåŠæœ‰å¤±å»çš„æ•…äº‹ã€‚',
    despair: 'åƒæ˜¯åœ¨å¾ˆæ·±çš„æ°´è£¡ï¼Œæš«æ™‚çœ‹ä¸åˆ°å‡ºå£ï¼Œä½†ä½ é‚„åœ¨é€™è£¡æ‰“å­—ï¼Œé€™æœ¬èº«å°±ä¸ç°¡å–®ã€‚',
    numb: 'éº»æœ¨ä¸¦ä¸ä»£è¡¨æ²’æœ‰æ„Ÿè¦ºï¼Œè€Œæ˜¯æƒ…ç·’å¤ªå¤šã€å¤ªé‡ï¼Œåªå¥½æš«æ™‚é—œå°éŸ³é‡ã€‚',
    hurt: 'è¢«èª¤è§£æˆ–è¢«å‚·åˆ°çš„åœ°æ–¹ï¼Œå¸¸å¸¸æ˜¯ä½ å¾ˆåœ¨æ„çš„åœ°æ–¹ã€‚'
  };

  let selectedValence = 0;
  let selectedHue = 200;
  let selectedEmotionKey = null;
  let debounceTimer = null;

  function resizeCanvases() {
    const rect = watercolorCanvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;

    watercolorCanvas.width = rect.width * dpr;
    watercolorCanvas.height = rect.height * dpr;
    watercolorCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

    crayonCanvas.width = rect.width * dpr;
    crayonCanvas.height = rect.height * dpr;
    crayonCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  window.addEventListener('resize', () => {
    resizeCanvases();
    regenerateNow();
  });

  // Emotion button
  emotionButtons.addEventListener('click', (e) => {
    const btn = e.target.closest('.emotion-btn');
    if (!btn) return;
    document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedValence = parseFloat(btn.dataset.valence || '0');
    selectedHue = parseFloat(btn.dataset.hue || '200');
    selectedEmotionKey = btn.dataset.key || null;
    const key = btn.dataset.key;
    if (key && emotionDescriptions[key]) {
      emotionDesc.textContent = emotionDescriptions[key];
    } else {
      emotionDesc.textContent = 'é¸ä¸€å€‹æœ€æ¥è¿‘çš„å°±å¥½ï¼Œä¸éœ€è¦ã€Œé¸å°ã€ã€‚é¡è‰²æœƒä¸€èµ·å¸¶é€²ç•«é¢è£¡ã€‚';
    }
    logAction('selectEmotion', { key, valence: selectedValence, hue: selectedHue });
    scheduleRegenerate();
  });

  // slider
  arousalSlider.addEventListener('input', () => {
    arousalValue.textContent = arousalSlider.value;
    logAction('changeArousal', { value: arousalSlider.value });
    scheduleRegenerate();
  });
  controlSlider.addEventListener('input', () => {
    controlValue.textContent = controlSlider.value;
    logAction('changeControl', { value: controlSlider.value });
    scheduleRegenerate();
  });
  socialSlider.addEventListener('input', () => {
    socialValue.textContent = socialSlider.value;
    logAction('changeSocial', { value: socialSlider.value });
    scheduleRegenerate();
  });

  // pill / chip
  function setupToggleContainer(container, name) {
    container.addEventListener('click', (e) => {
      const pill = e.target.closest('.radio-pill, .chip');
      if (!pill) return;
      const input = pill.querySelector('input');
      if (!input) return;
      if (input.type === 'radio') {
        container.querySelectorAll('.radio-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        input.checked = true;
      } else if (input.type === 'checkbox') {
        pill.classList.toggle('active');
        input.checked = !input.checked;
      }
      logAction('changeField', { group: name, value: input.value, checked: input.checked });
      scheduleRegenerate();
    });
  }
  setupToggleContainer(sourceGroup, 'source');
  setupToggleContainer(supportGroup, 'support');
  setupToggleContainer(bodyGroup, 'body');
  setupToggleContainer(selfGroup, 'selfAccept');

  // range group (history)
  setupToggleContainer(rangeGroup, 'range');
  rangeGroup.addEventListener('click', (e) => {
    const input = e.target.closest('label')?.querySelector('input');
    if (!input) return;
    currentRange = input.value;
    renderHistory(currentRange);
  });

  // text input
  moodText.addEventListener('input', () => {
    logAction('inputMood', { value: moodText.value });
    scheduleRegenerate();
  });
  triggerEventInput.addEventListener('input', () => {
    logAction('inputTriggerEvent', { value: triggerEventInput.value });
    scheduleRegenerate();
  });
  triggerPersonInput.addEventListener('input', () => {
    logAction('inputTriggerPerson', { value: triggerPersonInput.value });
    scheduleRegenerate();
  });

  // valence from text
  function analyzeTextValence(text) {
    const t = text || '';
    const lower = t.toLowerCase();
    let score = 0;

    const negWords = ['é›£é','å¥½ç´¯','å£“åŠ›','ç„¦æ…®','å´©æ½°','ç”Ÿæ°£','è¨å­','ä¸æƒ³','æ²®å–ª','å­¤å–®','ç…©','å®³æ€•','çµ•æœ›','éº»æœ¨','ç©ºæ‰','åµæ¶'];
    const posWords = ['æ„Ÿè¬','é–‹å¿ƒ','æœŸå¾…','å–œæ­¡','æ”¾é¬†','é‚„å¥½','èˆ’æœ','å……å¯¦','é †åˆ©','å¾ˆæ£’','å¹¸ç¦','å®‰å¿ƒ','è¢«ç†è§£'];

    negWords.forEach(w => { if (t.includes(w)) score -= 0.5; });
    posWords.forEach(w => { if (t.includes(w)) score += 0.5; });

    if (lower.includes('sad') || lower.includes('tired') || lower.includes('depress') || lower.includes('anxious')) score -= 0.5;
    if (lower.includes('happy') || lower.includes('grateful') || lower.includes('relax')) score += 0.5;

    if (score > 2) score = 2;
    if (score < -2) score = -2;
    return score;
  }

  // text multi emotion
  function analyzeTextEmotionKeywords(text) {
    const t = text || '';
    const defs = {
      anger: { hue: 0, words: ['ç”Ÿæ°£','æ†¤æ€’','ç«å¤§','ä¸çˆ½','è¢«æ”»æ“Š','åµæ¶','æ°£ç‚¸'] },
      sad: { hue: 210, words: ['é›£é','æ‚²å‚·','æƒ³å“­','å¤±è½','å¿ƒç—›','å¿ƒç¢'] },
      anxious: { hue: 90, words: ['ç„¦æ…®','ç·Šå¼µ','æ“”å¿ƒ','ä¸å®‰','å¿ƒæ…Œ','æ€•'] },
      joy: { hue: 60, words: ['é–‹å¿ƒ','å¿«æ¨‚','èˆˆå¥®','æœŸå¾…','å¹¸ç¦','æ„Ÿè¬'] },
      lonely: { hue: 250, words: ['å­¤å–®','å¯‚å¯','è¢«ä¸Ÿä¸‹','æ²’äººæ‡‚','è¢«å¿½ç•¥'] },
      numb: { hue: 280, words: ['éº»æœ¨','ç©ºæ‰','æ²’æœ‰æ„Ÿè¦º','åƒé—œéœéŸ³'] },
      tired: { hue: 35, words: ['å¥½ç´¯','ç–²æ†Š','æƒ³ç¡','ç´¯ç¿»','è€—ç›¡'] },
      calm: { hue: 130, words: ['å¹³éœ','å®‰ç©©','ç©©å®š','é‚„å¥½','OK'] }
    };

    const result = {};
    Object.entries(defs).forEach(([key, def]) => {
      let count = 0;
      def.words.forEach(w => {
        let idx = t.indexOf(w);
        while (idx !== -1) {
          count++;
          idx = t.indexOf(w, idx + w.length);
        }
      });
      if (count > 0) {
        result[key] = { count, hue: def.hue };
      }
    });
    return result;
  }

  // metrics
  function metricsFromInputs() {
    const text = moodText.value.trim();
    const textValence = analyzeTextValence(text);
    const textEmotions = analyzeTextEmotionKeywords(text);

    const valence = (selectedValence || 0) * 0.7 + textValence * 0.3;
    const arousal = parseInt(arousalSlider.value, 10);
    const control = parseInt(controlSlider.value, 10);
    const social = parseInt(socialSlider.value, 10);

    const supportInput = supportGroup.querySelector('input[name="support"]:checked');
    const support = supportInput ? parseInt(supportInput.value, 10) : 1;

    const selfInput = selfGroup.querySelector('input[name="selfAccept"]:checked');
    const selfAccept = selfInput ? parseInt(selfInput.value, 10) : 1;

    const bodyChecked = Array.from(bodyGroup.querySelectorAll('input[type="checkbox"]:checked'))
      .map(i => i.value);

    const sourceInput = sourceGroup.querySelector('input[name="source"]:checked');
    const sourceType = sourceInput ? sourceInput.value : 'thing';
    const triggerEvent = triggerEventInput.value.trim();
    const triggerPerson = triggerPersonInput.value.trim();

    const tenseKeys = ['head_pressure','eye_strain','shoulder_tense','chest_heavy','heart_fast','stomach_unwell','cold_limbs','body_tired'];
    let tension = bodyChecked.filter(v => tenseKeys.includes(v)).length;
    if (tension > 3) tension = 3;

    let baseHue = selectedHue || 200;
    baseHue = (baseHue + valence * 6 + 360) % 360;

    let saturation = 55 + (arousal - 1) * 8;
    saturation -= (control - 3) * 2;
    if (saturation < 45) saturation = 45;
    if (saturation > 90) saturation = 90;

    let lightness = 55 + selfAccept * 6 + (social - 3) * 2;
    if (lightness < 45) lightness = 45;
    if (lightness > 80) lightness = 80;

    const centerStrength = 0.25 + (support + social) * 0.1;
    let spread = 0.7 + (arousal - 3) * 0.18 - (control - 3) * 0.1;
    if (spread < 0.4) spread = 0.4;
    if (spread > 1.4) spread = 1.4;

    return {
      text,
      valence,
      arousal,
      control,
      social,
      support,
      selfAccept,
      tension,
      baseHue,
      saturation,
      lightness,
      centerStrength,
      spread,
      bodyChecked,
      sourceType,
      triggerEvent,
      triggerPerson,
      textEmotions,
      emotionKey: selectedEmotionKey
    };
  }

  function hslToRgba(h, s, l, a) {
    s /= 100;
    l /= 100;
    const C = (1 - Math.abs(2 * l - 1)) * s;
    const X = C * (1 - Math.abs((h / 60) % 2 - 1));
    const m = l - C / 2;
    let r1, g1, b1;
    if (h >= 0 && h < 60)      { r1 = C; g1 = X; b1 = 0; }
    else if (h < 120)          { r1 = X; g1 = C; b1 = 0; }
    else if (h < 180)          { r1 = 0; g1 = C; b1 = X; }
    else if (h < 240)          { r1 = 0; g1 = X; b1 = C; }
    else if (h < 300)          { r1 = X; g1 = 0; b1 = C; }
    else                       { r1 = C; g1 = 0; b1 = C; }
    const r = Math.round((r1 + m) * 255);
    const g = Math.round((g1 + m) * 255);
    const b = Math.round((b1 + m) * 255);
    return `rgba(${r},${g},${b},${a})`;
  }

  function drawBodyOverlays(metrics, w, h) {
    const { bodyChecked, baseHue } = metrics;
    if (!bodyChecked || !bodyChecked.length) return;

    bodyChecked.forEach(type => {
      switch (type) {
        case 'head_pressure': {
          const cx = w / 2;
          const cy = h * 0.1;
          const r = w * 0.25;
          const grad = watercolorCtx.createRadialGradient(cx, cy, 0, cx, cy, r);
          grad.addColorStop(0, hslToRgba(baseHue - 15, 45, 45, 0.18));
          grad.addColorStop(1, hslToRgba(baseHue - 15, 45, 45, 0));
          watercolorCtx.fillStyle = grad;
          watercolorCtx.beginPath();
          watercolorCtx.arc(cx, cy, r, 0, Math.PI * 2);
          watercolorCtx.fill();
          break;
        }
        case 'eye_strain': {
          watercolorCtx.fillStyle = hslToRgba(baseHue - 5, 40, 60, 0.16);
          const rw = w * 0.5;
          const rh = h * 0.06;
          watercolorCtx.fillRect((w - rw)/2, h*0.12, rw, rh);
          break;
        }
        case 'shoulder_tense': {
          const grad = watercolorCtx.createLinearGradient(0, h*0.18, 0, h*0.3);
          grad.addColorStop(0, hslToRgba(baseHue - 10, 45, 50, 0.18));
          grad.addColorStop(1, hslToRgba(baseHue - 10, 45, 50, 0));
          watercolorCtx.fillStyle = grad;
          watercolorCtx.fillRect(w*0.1, h*0.2, w*0.8, h*0.15);
          break;
        }
        case 'chest_heavy': {
          const cx = w / 2;
          const cy = h * 0.4;
          const r = w * 0.3;
          const grad = watercolorCtx.createRadialGradient(cx, cy, 0, cx, cy, r);
          grad.addColorStop(0, hslToRgba(baseHue - 20, 50, 45, 0.18));
          grad.addColorStop(1, hslToRgba(baseHue - 20, 50, 45, 0));
          watercolorCtx.fillStyle = grad;
          watercolorCtx.beginPath();
          watercolorCtx.arc(cx, cy, r, 0, Math.PI * 2);
          watercolorCtx.fill();
          break;
        }
        case 'heart_fast': {
          const cx = w / 2;
          const cy = h * 0.36;
          const r = w * 0.18;
          const grad = watercolorCtx.createRadialGradient(cx, cy, 0, cx, cy, r);
          grad.addColorStop(0, hslToRgba(0, 80, 60, 0.26));
          grad.addColorStop(1, hslToRgba(0, 80, 60, 0));
          watercolorCtx.fillStyle = grad;
          watercolorCtx.beginPath();
          watercolorCtx.arc(cx, cy, r, 0, Math.PI * 2);
          watercolorCtx.fill();
          break;
        }
        case 'stomach_unwell': {
          const cx = w / 2;
          const cy = h * 0.6;
          const r = w * 0.25;
          const grad = watercolorCtx.createRadialGradient(cx, cy, 0, cx, cy, r);
          grad.addColorStop(0, hslToRgba(baseHue - 25, 50, 45, 0.18));
          grad.addColorStop(1, hslToRgba(baseHue - 25, 50, 45, 0));
          watercolorCtx.fillStyle = grad;
          watercolorCtx.beginPath();
          watercolorCtx.arc(cx, cy, r, 0, Math.PI * 2);
          watercolorCtx.fill();
          break;
        }
        case 'cold_limbs': {
          watercolorCtx.fillStyle = hslToRgba(210, 40, 70, 0.18);
          const r = w * 0.06;
          watercolorCtx.beginPath();
          watercolorCtx.arc(w*0.12, h*0.78, r, 0, Math.PI*2);
          watercolorCtx.arc(w*0.88, h*0.78, r, 0, Math.PI*2);
          watercolorCtx.arc(w*0.18, h*0.55, r, 0, Math.PI*2);
          watercolorCtx.arc(w*0.82, h*0.55, r, 0, Math.PI*2);
          watercolorCtx.fill();
          break;
        }
        case 'body_tired': {
          const grad = watercolorCtx.createLinearGradient(0, h*0.4, 0, h);
          grad.addColorStop(0, hslToRgba(baseHue + 190, 25, 55, 0.14));
          grad.addColorStop(1, hslToRgba(baseHue + 190, 25, 45, 0.2));
          watercolorCtx.fillStyle = grad;
          watercolorCtx.fillRect(0, h*0.4, w, h*0.6);
          break;
        }
        case 'belly_warm': {
          const cx = w / 2;
          const cy = h * 0.6;
          const r = w * 0.22;
          const grad = watercolorCtx.createRadialGradient(cx, cy, 0, cx, cy, r);
          grad.addColorStop(0, hslToRgba(35, 80, 75, 0.22));
          grad.addColorStop(1, hslToRgba(35, 80, 75, 0));
          watercolorCtx.fillStyle = grad;
          watercolorCtx.beginPath();
          watercolorCtx.arc(cx, cy, r, 0, Math.PI * 2);
          watercolorCtx.fill();
          break;
        }
        case 'body_relaxed': {
          const grad = watercolorCtx.createRadialGradient(w/2, h*0.5, 0, w/2, h*0.5, Math.max(w,h)*0.6);
          grad.addColorStop(0, hslToRgba(140, 40, 80, 0.22));
          grad.addColorStop(1, hslToRgba(140, 40, 80, 0));
          watercolorCtx.fillStyle = grad;
          watercolorCtx.fillRect(0, 0, w, h);
          break;
        }
      }
    });
  }

  function drawTextEmotionDots(metrics, w, h) {
    const ems = Object.entries(metrics.textEmotions || {});
    if (!ems.length) return;

    const total = ems.reduce((sum, [, v]) => sum + v.count, 0);
    if (total === 0) return;
    const maxCount = Math.max(...ems.map(([, v]) => v.count));
    const tightness = maxCount / total;

    const centerX = w / 2;
    const centerY = h / 2;
    const minSize = Math.min(w, h);

    ems.forEach(([key, v], idx) => {
      const count = v.count;
      const hue = v.hue;
      const angle = (idx / ems.length) * Math.PI * 2;
      const clusterDistance = (0.2 + (1 - tightness) * 0.25) * minSize;
      const cx = centerX + Math.cos(angle) * clusterDistance;
      const cy = centerY + Math.sin(angle) * clusterDistance;
      const dots = 3 + count * 2;
      const clusterRadius = 20 + count * 6;

      for (let i = 0; i < dots; i++) {
        const r = 3 + Math.random() * 4;
        const theta = Math.random() * Math.PI * 2;
        const dist = Math.random() * clusterRadius;
        const x = cx + Math.cos(theta) * dist;
        const y = cy + Math.sin(theta) * dist;
        watercolorCtx.fillStyle = hslToRgba(hue, 80, 65, 0.85);
        watercolorCtx.beginPath();
        watercolorCtx.arc(x, y, r, 0, Math.PI * 2);
        watercolorCtx.fill();
      }
    });
  }

  function drawWatercolor(metrics) {
    const {
      valence, arousal, tension, baseHue, saturation, lightness,
      centerStrength, spread
    } = metrics;

    const w = watercolorCanvas.width / (window.devicePixelRatio || 1);
    const h = watercolorCanvas.height / (window.devicePixelRatio || 1);

    watercolorCtx.clearRect(0, 0, w, h);

    watercolorCtx.fillStyle = '#ffffff';
    watercolorCtx.fillRect(0, 0, w, h);
    const bgColor = hslToRgba(baseHue, saturation * 0.5, lightness + 5, 0.12);
    watercolorCtx.fillStyle = bgColor;
    watercolorCtx.globalAlpha = 1;
    watercolorCtx.fillRect(0, 0, w, h);

    const blobs = 55 + arousal * 8 + (5 - (metrics.control || 3)) * 5;
    for (let i = 0; i < blobs; i++) {
      const centerX = w / 2;
      const centerY = h / 2;
      const randAngle = Math.random() * Math.PI * 2;
      const randRadius = (Math.random() ** centerStrength) *
        (Math.min(w, h) / 2 * spread);
      const x = centerX + Math.cos(randAngle) * randRadius;
      const y = centerY + Math.sin(randAngle) * randRadius;

      const baseR = Math.min(w, h) / 13;
      const radius = baseR * (0.6 + arousal * 0.25 + Math.random());

      const hueJitter = (Math.random() - 0.5) * 22;
      const localHue = (baseHue + hueJitter + 360) % 360;
      const localSat = saturation + (Math.random() - 0.5) * 10;
      const localLight = lightness + (Math.random() - 0.5) * 10;
      const gradient = watercolorCtx.createRadialGradient(x, y, 0, x, y, radius);
      const alphaCenter = 0.12 + arousal * 0.02;
      gradient.addColorStop(0, hslToRgba(localHue, localSat, localLight, alphaCenter));
      gradient.addColorStop(1, hslToRgba(localHue, localSat, localLight, 0));

      watercolorCtx.globalAlpha = 1;
      watercolorCtx.fillStyle = gradient;
      watercolorCtx.beginPath();
      watercolorCtx.arc(x, y, radius, 0, Math.PI * 2);
      watercolorCtx.fill();
    }

    // ç·Šç¹ƒç·šæ¢ï¼šé€æ˜åº¦ & æŸ”å’Œåº¦æé«˜
    if (tension > 0) {
      const lines = 10 * tension;
      watercolorCtx.globalAlpha = 0.18 + tension * 0.04;
      watercolorCtx.lineCap = 'round';
      watercolorCtx.lineJoin = 'round';
      for (let i = 0; i < lines; i++) {
        let startX = Math.random() * w;
        let startY = Math.random() * h;
        let len = (Math.random() * 0.35 + 0.1) * Math.min(w, h);
        const angle = (Math.random() * 0.6 - 0.3) + (valence < 0 ? -Math.PI / 2 : -Math.PI / 4);
        const cp1x = startX + Math.cos(angle) * len * 0.4 + (Math.random() - 0.5) * 20;
        const cp1y = startY + Math.sin(angle) * len * 0.4 + (Math.random() - 0.5) * 20;
        const endX = startX + Math.cos(angle) * len;
        const endY = startY + Math.sin(angle) * len;

        const lineHue = (baseHue + (valence < 0 ? -10 : 10) + 360) % 360;
        watercolorCtx.strokeStyle = hslToRgba(lineHue, saturation + 5, lightness - 10, 0.7);
        watercolorCtx.lineWidth = 0.8 + Math.random() * 1.4;
        watercolorCtx.beginPath();
        watercolorCtx.moveTo(startX, startY);
        watercolorCtx.quadraticCurveTo(cp1x, cp1y, endX, endY);
        watercolorCtx.stroke();
      }
    }

    watercolorCtx.globalAlpha = 1;
    drawBodyOverlays(metrics, w, h);
    drawTextEmotionDots(metrics, w, h);
  }

  function updateSummary(metrics) {
    const { valence, arousal, support, selfAccept, tension, control, social, sourceType } = metrics;

    let tone = '';
    if (valence <= -1.2) tone = 'ç•«é¢åŸºåº•åå†·æˆ–åæš—ï¼Œåƒæ˜¯æœ€è¿‘æœ‰ä¸å°‘æ²ˆé‡æˆ–è¾›è‹¦çš„æ„Ÿå—ã€‚';
    else if (valence < 0.3) tone = 'é¡è‰²åœ¨å†·æš–ä¹‹é–“ï¼Œå°æ‡‰ä¸€ç¨®æ··é›œã€èªªä¸ä¸Šå¥½å£çš„ç‹€æ…‹ã€‚';
    else tone = 'æ•´é«”è‰²èª¿åæš–ã€è¼ƒäº®ï¼Œåƒæ˜¯ä½ é‚„ä¿ç•™è‘—ä¸€äº›äº®åº¦èˆ‡å¸Œæœ›ã€‚';

    let aDesc = '';
    if (arousal >= 4) aDesc = 'æƒ…ç·’å¼·åº¦åé«˜ï¼Œæ‰€ä»¥æ°´å½©è‰²å¡Šæ“´æ•£å¾—æ¯”è¼ƒå¥”æ”¾ã€‚';
    else if (arousal <= 2) aDesc = 'æƒ…ç·’å¼·åº¦è¼ƒä½ï¼Œè‰²å¡Šä¹Ÿæ¯”è¼ƒé›†ä¸­ã€å®‰éœã€‚';
    else aDesc = 'å¼·åº¦é©ä¸­ï¼Œè‰²å½©åœ¨ç•«é¢è£¡æ…¢æ…¢åœ°é‹ªæ•£é–‹ä¾†ã€‚';

    let cDesc = '';
    if (control <= 2) cDesc = 'æŒæ§æ„Ÿåä½ï¼Œç•«é¢ç¨å¾®é¡¯å¾—å‡Œäº‚ä¸€é»ï¼Œåƒåœ¨æé†’æƒ…ç·’æ­¤åˆ»å¾ˆæœ‰ä»½é‡ã€‚';
    else if (control >= 4) cDesc = 'æŒæ§æ„Ÿåé«˜ï¼Œæ“´æ•£ç¯„åœæ”¶æ–‚ä¸€äº›ï¼Œè¡¨ç¤ºä½ åœ¨æ··äº‚è£¡é‚„æŠ“å¾—åˆ°æŸäº›é‡å¿ƒã€‚';
    else cDesc = 'æŒæ§æ„Ÿå±…ä¸­ï¼Œä½ æ—¢å—åˆ°æƒ…ç·’å½±éŸ¿ï¼Œä¹Ÿé‚„åœ¨æ‰¾èª¿æ•´çš„ç©ºé–“ã€‚';

    let sDesc = '';
    if (social <= 2) sDesc = 'é€£çµæ„Ÿåä½ï¼Œç•«é¢åˆ»æ„ç•™äº†ä¸€äº›ç©ºç™½èˆ‡è¼ƒå†·çš„è‰²å¡Šï¼Œåƒå°šæœªè¢«å¡«æ»¿çš„ä½ç½®ã€‚';
    else if (social >= 4) sDesc = 'é€£çµæ„Ÿåé«˜ï¼Œè‰²å¡Šè¼ƒé›†ä¸­ï¼Œç•«é¢æ ¸å¿ƒæœ‰ä¸€ç¨®è¢«åœç¹ã€è¢«æ¥ä½çš„æ„Ÿè¦ºã€‚';
    else sDesc = 'é€£çµæ„Ÿåœ¨ä¸­é–“ï¼Œè‡ªæˆ‘èˆ‡ä»–äººä¹‹é–“ä¾ç„¶åœ¨èª¿æ•´è·é›¢ã€‚';

    let tDesc = '';
    if (tension >= 2) tDesc = 'èº«é«”ç·Šç¹ƒæ„Ÿé€éæŸ”è»Ÿä½†æ˜é¡¯çš„ç·šæ¢è¢«ç•«é€²å»äº†ï¼Œé‚£äº›éƒ½æ˜¯å¾ˆå€¼å¾—è¢«çœ‹è¦‹çš„è¨Šè™Ÿã€‚';
    else if (tension === 1) tDesc = 'æœ‰ä¸€äº›ç·Šç¹ƒè¢«ç•«åœ¨ç•«é¢ä¸Šï¼Œä½†ä»ç•™æœ‰ç©ºé–“è®“é¡è‰²æµå‹•ã€‚';
    else tDesc = 'ç·šæ¢ä¸å¤šï¼Œä»£è¡¨èº«é«”ç›¸å°æ²’æœ‰é‚£éº¼ç·Šç¹ƒæˆ–è‡³å°‘æ²’æœ‰è¢«æƒ…ç·’å®Œå…¨æ‹‰èµ°ã€‚';

    let srcDesc = '';
    if (sourceType === 'person') srcDesc = 'é€™æ¬¡çš„æƒ…ç·’æ¯”è¼ƒè·Ÿã€Œäººæˆ–é—œä¿‚ã€æœ‰é—œï¼Œä¹‹å¾Œè‹¥é¡˜æ„ï¼Œä¹Ÿå¯ä»¥å›é ­çœ‹çœ‹ï¼šå°ä½ æœ€åœ¨æ„çš„æ˜¯å“ªä¸€å¡Šã€‚';
    else if (sourceType === 'thing') srcDesc = 'é€™æ¬¡çš„æƒ…ç·’ä¸»è¦ä¾†è‡ªæŸå€‹äº‹ä»¶æˆ–æƒ…å¢ƒï¼Œæœ‰æ™‚ä¹Ÿæœƒç‰½å‹•ä½ å°è‡ªå·±çš„çœ‹æ³•ã€‚';
    else if (sourceType === 'self') srcDesc = 'é€™ä»½æ„Ÿå—æ¯”è¼ƒåƒæ˜¯ä¾†è‡ªè‡ªå·±æœ¬èº«ï¼ˆèº«é«”æˆ–å€‹æ€§ï¼‰ï¼Œé€™æ¨£çš„è¦ºå¯Ÿæœ¬èº«å°±å¾ˆä¸å®¹æ˜“ã€‚';
    else srcDesc = 'ä¾†æºæš«æ™‚èªªä¸å¤ªä¸Šä¾†ä¹Ÿæ²’é—œä¿‚ï¼Œæœ‰æ™‚å€™æƒ…ç·’åªæ˜¯å…ˆå‡ºç¾ï¼Œç†è§£æœƒæ…¢ä¸€é»åˆ°ã€‚';

    let selfDesc = '';
    if (selfAccept === 2) selfDesc = 'ç•«é¢äº®åº¦ç¨å¾®æé«˜ï¼Œå‘¼æ‡‰ä½ é¡˜æ„å°ç¾åœ¨çš„è‡ªå·±å¤šä¸€é»ç†è§£èˆ‡æº«æŸ”ã€‚';
    else if (selfAccept === 0) selfDesc = 'å¦‚æœæ­¤åˆ»å°è‡ªå·±æœ‰é»è‹›è²¬ï¼Œç•«é¢è£¡çš„å°æ¯”èˆ‡é™°å½±ï¼Œå‰›å¥½ä¹Ÿåœ¨æé†’ï¼šé‚£äº›æ‰¹åˆ¤çš„è²éŸ³ä¹Ÿå€¼å¾—è¢«å¥½å¥½çœ‹ä¸€çœ¼ã€‚';
    else selfDesc = 'ä½ å°è‡ªå·±çš„æ…‹åº¦åä¸­æ€§ï¼Œå› æ­¤ç•«é¢ä¹Ÿè½åœ¨æ˜æš—ä¹‹é–“çš„ä¸€å€‹æŠ˜è¡·ã€‚';

    summaryText.innerHTML = tone + '<br>' + aDesc + ' ' + cDesc + '<br>' + sDesc + '<br>' + tDesc + '<br>' + srcDesc + '<br>' + selfDesc;
    summaryText.style.display = 'block';
  }

  function regenerateNow() {
    const metrics = metricsFromInputs();
    drawWatercolor(metrics);
    updateSummary(metrics);
    logAction('regenerate', {
      valence: metrics.valence,
      arousal: metrics.arousal,
      control: metrics.control,
      social: metrics.social,
      support: metrics.support,
      selfAccept: metrics.selfAccept,
      body: metrics.bodyChecked,
      sourceType: metrics.sourceType
    });
  }
  function scheduleRegenerate() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(regenerateNow, 250);
  }

  // ====== è Ÿç­†ï¼ˆå‚ç›´å°ç¨±ï¼‹æŸ”è»Ÿå¼§ç·šï¼‰ ======
  let currentCrayonColor = '#263238';
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;
  let lastMidX = 0;
  let lastMidY = 0;
  let hasLastMid = false;

  function getCanvasPos(e) {
    const rect = crayonCanvas.getBoundingClientRect();
    const isTouch = e.touches && e.touches.length > 0;
    const clientX = isTouch ? e.touches[0].clientX : e.clientX;
    const clientY = isTouch ? e.touches[0].clientY : e.clientY;
    return {
      x: clientX - rect.left,
      y: clientY - rect.top,
      width: rect.width
    };
  }

  function startDrawing(e) {
    e.preventDefault();
    const pos = getCanvasPos(e);
    isDrawing = true;
    lastX = pos.x;
    lastY = pos.y;
    lastMidX = pos.x;
    lastMidY = pos.y;
    hasLastMid = false;
    logAction('startDrawing', { x: pos.x, y: pos.y, color: currentCrayonColor });
  }

  function drawCrayon(e) {
    if (!isDrawing) return;
    e.preventDefault();
    const pos = getCanvasPos(e);
    const rectWidth = pos.width;

    const nowX = pos.x;
    const nowY = pos.y;
    const midX = (lastX + nowX) / 2;
    const midY = (lastY + nowY) / 2;

    crayonCtx.strokeStyle = currentCrayonColor;
    crayonCtx.lineWidth = 9;
    crayonCtx.lineCap = 'round';
    crayonCtx.lineJoin = 'round';
    crayonCtx.globalAlpha = 0.9;

    // åŸæœ¬é‚£æ¢ï¼ˆç”¨ quadratic curve æŸ”åŒ–ï¼‰
    crayonCtx.beginPath();
    if (!hasLastMid) {
      crayonCtx.moveTo(lastX, lastY);
    } else {
      crayonCtx.moveTo(lastMidX, lastMidY);
    }
    crayonCtx.quadraticCurveTo(lastX, lastY, midX, midY);
    crayonCtx.stroke();

    // å‚ç›´é¡åƒé‚£æ¢
    const mirrorLastX = rectWidth - lastX;
    const mirrorNowX = rectWidth - nowX;
    const mirrorMidX = (mirrorLastX + mirrorNowX) / 2;

    crayonCtx.beginPath();
    if (!hasLastMid) {
      crayonCtx.moveTo(mirrorLastX, lastY);
    } else {
      const mirrorLastMidX = rectWidth - lastMidX;
      crayonCtx.moveTo(mirrorLastMidX, lastMidY);
    }
    crayonCtx.quadraticCurveTo(mirrorLastX, lastY, mirrorMidX, midY);
    crayonCtx.stroke();

    logAction('drawSegment', {
      from: { x: lastX, y: lastY },
      to: { x: nowX, y: nowY },
      mirror: true,
      color: currentCrayonColor
    });

    lastX = nowX;
    lastY = nowY;
    lastMidX = midX;
    lastMidY = midY;
    hasLastMid = true;
  }

  function stopDrawing() {
    if (isDrawing) {
      logAction('stopDrawing', {});
    }
    isDrawing = false;
    hasLastMid = false;
  }

  crayonCanvas.addEventListener('mousedown', startDrawing);
  crayonCanvas.addEventListener('mousemove', drawCrayon);
  crayonCanvas.addEventListener('mouseup', stopDrawing);
  crayonCanvas.addEventListener('mouseleave', stopDrawing);
  crayonCanvas.addEventListener('touchstart', startDrawing, { passive: false });
  crayonCanvas.addEventListener('touchmove', drawCrayon, { passive: false });
  crayonCanvas.addEventListener('touchend', stopDrawing);

  crayonColors.addEventListener('click', (e) => {
    const btn = e.target.closest('.crayon-color-btn');
    if (!btn) return;
    document.querySelectorAll('.crayon-color-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentCrayonColor = btn.dataset.color || '#263238';
    logAction('changeCrayonColor', { color: currentCrayonColor });
  });

  // ====== å­˜æª”ï¼‹ä¸‹è¼‰ï¼ˆåªåœ–ï¼‰ ======
  function saveRecordAndDownload() {
    const metrics = metricsFromInputs();

    const exportCanvas = document.createElement('canvas');
    exportCanvas.width = watercolorCanvas.width;
    exportCanvas.height = watercolorCanvas.height;
    const exportCtx = exportCanvas.getContext('2d');
    exportCtx.drawImage(watercolorCanvas, 0, 0);
    exportCtx.drawImage(crayonCanvas, 0, 0);
    const imageDataUrl = exportCanvas.toDataURL('image/png');

    const snippet = (metrics.text || '').slice(0, 80);
    const record = {
      id: Date.now(),
      user: currentUser,
      createdAt: new Date().toISOString(),
      metrics,
      textSnippet: snippet,
      imageDataUrl
    };
    records.push(record);
    persistRecords();
    renderHistory(currentRange);

    logAction('saveRecord', { id: record.id });

    const imgLink = document.createElement('a');
    imgLink.download = 'emotion-watercolor.png';
    imgLink.href = imageDataUrl;
    imgLink.click();
  }

  downloadBtn.addEventListener('click', saveRecordAndDownload);

  // ====== History view ======
  const emotionLabels = {
    anger: 'æ†¤æ€’',
    fight: 'è¢«é»ç‡ƒ',
    playful: 'å¥½ç©',
    smallJoy: 'å°ç¢ºå¹¸',
    joy: 'é–‹å¿ƒ',
    anxious: 'ç„¦æ…®',
    calm: 'å¹³éœ',
    lonely: 'å­¤å–®',
    sad: 'æ‚²å‚·',
    despair: 'çµ•æœ›',
    numb: 'éº»æœ¨',
    hurt: 'å—å‚·',
    tired: 'ç–²æ†Š'
  };

  const emotionHueMap = {
    anger: 0,
    fight: 20,
    playful: 35,
    smallJoy: 45,
    joy: 60,
    anxious: 90,
    calm: 130,
    lonely: 170,
    sad: 210,
    despair: 250,
    numb: 280,
    hurt: 320,
    tired: 35
  };

  function filterRecordsByRange(range) {
    if (!records.length) return [];
    const now = new Date();
    return records.filter(r => {
      if (!r.createdAt) return false;
      const d = new Date(r.createdAt);
      if (range === 'day') {
        return d.toDateString() === now.toDateString();
      } else if (range === 'week') {
        const diff = now - d;
        return diff <= 7 * 24 * 60 * 60 * 1000;
      } else if (range === 'month') {
        const diff = now - d;
        return diff <= 30 * 24 * 60 * 60 * 1000;
      }
      return true;
    });
  }

  function renderStats(range) {
    const filtered = filterRecordsByRange(range);
    statsChart.innerHTML = '';
    if (!filtered.length) {
      statsChart.textContent = 'ç›®å‰é€™å€‹æ™‚é–“ç¯„åœå…§æ²’æœ‰ç´€éŒ„ã€‚å…ˆå¾å‰µä½œç•«å¸ƒé–‹å§‹ä¸€å¹…ä½œå“å§ã€‚';
      return;
    }

    const counts = {};
    filtered.forEach(r => {
      const key = r.metrics?.emotionKey;
      if (key) {
        counts[key] = (counts[key] || 0) + 1;
      }
      const textEmo = r.metrics?.textEmotions || {};
      Object.entries(textEmo).forEach(([k, v]) => {
        counts[k] = (counts[k] || 0) + (v.count || 0);
      });
    });

    const entries = Object.entries(counts).sort((a,b) => b[1] - a[1]);
    const maxCount = entries.length ? Math.max(...entries.map(e => e[1])) : 1;

    entries.forEach(([key, value]) => {
      const row = document.createElement('div');
      row.className = 'bar-row';

      const labelSpan = document.createElement('span');
      labelSpan.className = 'bar-label';
      labelSpan.textContent = emotionLabels[key] || key;

      const track = document.createElement('div');
      track.className = 'bar-track';

      const fill = document.createElement('div');
      fill.className = 'bar-fill';
      const widthPercent = maxCount === 0 ? 0 : (value / maxCount) * 100;
      fill.style.width = widthPercent + '%';
      const hue = emotionHueMap[key] ?? 200;
      fill.style.background = `hsl(${hue}, 80%, 60%)`;

      track.appendChild(fill);

      const valueSpan = document.createElement('span');
      valueSpan.className = 'bar-value';
      valueSpan.textContent = value;

      row.appendChild(labelSpan);
      row.appendChild(track);
      row.appendChild(valueSpan);
      statsChart.appendChild(row);
    });
  }

  function applyRecordToInputs(rec) {
    const m = rec.metrics || {};
    moodText.value = m.text || '';
    arousalSlider.value = m.arousal || 3;
    arousalValue.textContent = arousalSlider.value;
    controlSlider.value = m.control || 3;
    controlValue.textContent = controlSlider.value;
    socialSlider.value = m.social || 3;
    socialValue.textContent = socialSlider.value;

    // source
    if (m.sourceType) {
      const input = sourceGroup.querySelector(`input[value="${m.sourceType}"]`);
      sourceGroup.querySelectorAll('.radio-pill').forEach(p => p.classList.remove('active'));
      if (input) {
        input.checked = true;
        input.closest('.radio-pill').classList.add('active');
      }
    }
    triggerEventInput.value = m.triggerEvent || '';
    triggerPersonInput.value = m.triggerPerson || '';

    // support
    if (typeof m.support === 'number') {
      const input = supportGroup.querySelector(`input[value="${m.support}"]`);
      supportGroup.querySelectorAll('.radio-pill').forEach(p => p.classList.remove('active'));
      if (input) {
        input.checked = true;
        input.closest('.radio-pill').classList.add('active');
      }
    }

    // selfAccept
    if (typeof m.selfAccept === 'number') {
      const input = selfGroup.querySelector(`input[value="${m.selfAccept}"]`);
      selfGroup.querySelectorAll('.radio-pill').forEach(p => p.classList.remove('active'));
      if (input) {
        input.checked = true;
        input.closest('.radio-pill').classList.add('active');
      }
    }

    // body
    bodyGroup.querySelectorAll('.chip').forEach(chip => {
      chip.classList.remove('active');
      const input = chip.querySelector('input');
      if (input) input.checked = false;
    });
    (m.bodyChecked || []).forEach(val => {
      const input = bodyGroup.querySelector(`input[value="${val}"]`);
      if (input) {
        input.checked = true;
        input.closest('.chip').classList.add('active');
      }
    });

    // emotion button
    if (m.emotionKey) {
      document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('active'));
      const btn = emotionButtons.querySelector(`.emotion-btn[data-key="${m.emotionKey}"]`);
      if (btn) {
        btn.classList.add('active');
        selectedValence = parseFloat(btn.dataset.valence || '0');
        selectedHue = parseFloat(btn.dataset.hue || '200');
        selectedEmotionKey = m.emotionKey;
        const key = m.emotionKey;
        if (key && emotionDescriptions[key]) {
          emotionDesc.textContent = emotionDescriptions[key];
        }
      }
    }

    regenerateNow();
    tabCreate.click();
  }

  function renderRecords(range) {
    const filtered = filterRecordsByRange(range).slice().sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
    recordsList.innerHTML = '';
    if (!filtered.length) {
      const empty = document.createElement('div');
      empty.className = 'record-empty';
      empty.textContent = 'é€™å€‹æ™‚é–“ç¯„åœå…§é‚„æ²’æœ‰ä½œå“ç´€éŒ„ã€‚';
      recordsList.appendChild(empty);
      return;
    }

    filtered.forEach(rec => {
      const card = document.createElement('div');
      card.className = 'record-card';

      const left = document.createElement('div');
      const right = document.createElement('div');

      const meta = document.createElement('div');
      meta.className = 'record-meta';
      const d = new Date(rec.createdAt);
      meta.textContent = d.toLocaleString('zh-TW', { hour12: false });

      const text = document.createElement('div');
      text.className = 'record-text';
      text.textContent = rec.textSnippet || 'ï¼ˆç•¶æ™‚æ²’æœ‰è¼¸å…¥æ–‡å­—ï¼‰';

      const badges = document.createElement('div');
      badges.className = 'record-badges';

      if (rec.metrics?.emotionKey) {
        const b = document.createElement('span');
        b.className = 'badge main';
        b.textContent = 'ä¸»æƒ…ç·’ï¼š' + (emotionLabels[rec.metrics.emotionKey] || rec.metrics.emotionKey);
        badges.appendChild(b);
      }

      const emoKeys = Object.keys(rec.metrics?.textEmotions || {});
      if (emoKeys.length) {
        const b = document.createElement('span');
        b.className = 'badge';
        const labels = emoKeys.map(k => emotionLabels[k] || k);
        b.textContent = 'æ–‡å­—æƒ…ç·’ï¼š' + labels.join('ã€');
        badges.appendChild(b);
      }

      const loadBtn = document.createElement('button');
      loadBtn.className = 'ghost';
      loadBtn.style.marginTop = '6px';
      loadBtn.textContent = 'è¼‰å…¥åˆ°ç•«å¸ƒ';
      loadBtn.addEventListener('click', () => applyRecordToInputs(rec));

      left.appendChild(meta);
      left.appendChild(text);
      left.appendChild(badges);
      left.appendChild(loadBtn);

      const img = document.createElement('img');
      img.className = 'record-img';
      img.src = rec.imageDataUrl;
      img.alt = 'æƒ…ç·’ä½œå“';

      right.appendChild(img);

      card.appendChild(left);
      card.appendChild(right);
      recordsList.appendChild(card);
    });
  }

  function renderHistory(range) {
    renderStats(range);
    renderRecords(range);
  }

  // åˆå§‹åŒ–
  resizeCanvases();
  regenerateNow();
</script>
</body>
</html>
